<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reserva de Salas & Auditório</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --card:#0b1222; --line:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; }
    body{background:linear-gradient(180deg, var(--bg), #0a0f1d); color:var(--text);} 
    .app-wrap{max-width:1100px; margin:32px auto; padding:12px;}
    .glass{background:rgba(255,255,255,0.02); border:1px solid var(--line); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);} 
    .badge-room{font-weight:600; letter-spacing:.2px}
    .form-control, .form-select{background:#0a1326; color:var(--text); border:1px solid #20304d}
    .form-control::placeholder{color:#6b7280}
    .btn-accent{background:var(--accent); color:#0b101a; border:0}
    .btn-accent:hover{filter:brightness(.95)}
    .btn-outline{border:1px solid #324566; color:#d1d5db}
    .btn-outline:hover{background:#0a1326}
    .table{color:var(--text)}
    .table thead{background:#0c152b}
    .table tbody tr{border-color:#1f2c47}
    .link{color:#93c5fd; text-decoration:none}
    .link:hover{text-decoration:underline}
    .chip{display:inline-block; padding:.25rem .55rem; border-radius:999px; background:#0a1326; border:1px solid #21324f; color:#cbd5e1; font-size:.8rem}
    .danger{color:var(--danger)}
    .filter-bar{gap:.5rem}
    .small{font-size:.88rem}
  </style>
</head>
<body>
  <div class="app-wrap">
    <header class="glass p-4 mb-3 d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h3 mb-1">Reserva de Salas & Auditório</h1>
        <p class="text-secondary mb-0 small">Back-end: Google Planilhas/Apps Script. Acesso restrito ao domínio <strong>@mpmt.mp.br</strong>.</p>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnAdmin" class="btn btn-outline btn-sm">Modo Admin</button>
        <button id="btnExportCSV" class="btn btn-outline btn-sm">Exportar CSV (filtro)</button>
      </div>
    </header>

    <section class="glass p-4 mb-3">
      <h2 class="h5 mb-3">Nova reserva</h2>
      <form id="formReserva" class="row g-3">
        <input type="hidden" id="editId" value="" />
        <div class="col-md-4">
          <label class="form-label">Sala/Ambiente</label>
          <select id="room" class="form-select" required>
            <option value="">Carregando salas...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Data</label>
          <input id="date" type="date" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Início</label>
          <input id="start" type="time" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Fim</label>
          <input id="end" type="time" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Título/Evento</label>
          <input id="title" type="text" class="form-control" placeholder="Reunião do Projeto X" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Responsável</label>
          <input id="owner" type="text" class="form-control" placeholder="Nome e contato" required>
        </div>
        <div class="col-12">
          <label class="form-label">Observações</label>
          <input id="notes" type="text" class="form-control" placeholder="Equipamentos, coffee, layout, etc. (opcional)">
        </div>

        <div id="recurrenceBlock" class="col-12 d-flex align-items-center gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="recWeekly">
            <label class="form-check-label" for="recWeekly">Repetir semanalmente</label>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0 small">Ocorrências</label>
            <input id="recCount" type="number" min="1" max="52" value="4" class="form-control" style="width:90px">
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button class="btn btn-accent" type="submit" id="btnSave">Salvar reserva</button>
          <button class="btn btn-outline" type="button" id="btnCancelEdit" style="display:none">Cancelar edição</button>
          <button class="btn btn-outline" type="button" id="btnICS">Baixar .ICS desta reserva</button>
        </div>
        <div id="msg" class="small mt-2"></div>
      </form>
    </section>

    <section class="glass p-4 mb-3">
      <div class="d-flex flex-wrap filter-bar">
        <div class="d-flex align-items-center gap-2">
          <label class="small text-secondary">Sala:</label>
          <select id="fRoom" class="form-select form-select-sm" style="width:220px">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-secondary">De:</label>
          <input id="fFrom" type="date" class="form-control form-control-sm">
        </div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-secondary">Até:</label>
          <input id="fTo" type="date" class="form-control form-control-sm">
        </div>
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <label class="small text-secondary">Busca:</label>
          <input id="fQuery" type="text" class="form-control form-control-sm" placeholder="título, responsável, observações">
        </div>
        <button id="btnClearFilters" class="btn btn-outline btn-sm">Limpar filtros</button>
      </div>
    </section>

    <section class="glass p-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 mb-0">Agenda</h2>
        <div class="small text-secondary" id="countInfo"></div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle" id="table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Início</th>
              <th>Fim</th>
              <th>Ambiente</th>
              <th>Título</th>
              <th>Responsável</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p class="text-secondary small mb-0">Dica: clique no título para ver detalhes / copiar link da reserva.</p>
    </section>

    <footer class="text-center mt-4 mb-2 text-secondary small">RNascimento • App de Reservas (Google Planilhas) — domínio restrito a @mpmt.mp.br.</footer>
  </div>

  <script>
    // ===== CONFIG =====
    const WEB_APP_URL = 'COLE_AQUI_A_URL_DA_IMPLANTACAO_DO_APPS_SCRIPT';

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const fmtDate = (d) => new Date(d+"T00:00:00").toLocaleDateString('pt-BR');
    const pad = (n) => (""+n).padStart(2,'0');
    const toMinutes = (hhmm)=>{const [h,m]=hhmm.split(":").map(Number);return h*60+m};
    function escapeCSV(s){return (s||'').replace(/\\"/g,'""')}

    // ===== Estado =====
    let state = {
      reservations: [],
      admin: false,
      adminPin: null,
      rooms: [],
      editingId: ''
    };

    // ===== API =====
    async function apiList(){
      const params = new URLSearchParams({ action:'list', fRoom: $('#fRoom').value||'', fFrom: $('#fFrom').value||'', fTo: $('#fTo').value||'', fQuery: $('#fQuery').value||'' });
      const r = await fetch(`${WEB_APP_URL}?${params.toString()}`);
      const j = await r.json(); if(!j.ok){ throw new Error(j.error||'Falha ao listar'); } return j;
    }
    async function apiRooms(){
      const r = await fetch(`${WEB_APP_URL}?action=rooms`); const j = await r.json(); if(!j.ok) throw new Error(j.error||'Falha ao carregar salas'); return j.rooms||[];
    }
    async function apiAdd(payload){ const r = await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'add',...payload})}); return r.json(); }
    async function apiUpdate(payload){ const r = await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'update',...payload})}); return r.json(); }
    async function apiDelete(id){ const pin = state.adminPin||''; const r = await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'delete',id,pin})}); return r.json(); }

    // ===== Render =====
    function render(){
      const tbody = $('#tbody');
      const list = state.reservations;
      $('#countInfo').textContent = `${list.length} reserva(s)`;
      tbody.innerHTML = list.map(r=>rowHTML(r)).join('');
    }
    function rowHTML(r){
      const roomBadge = `<span class="badge-room chip">${r.room}</span>`;
      const shareUrl = location.href.split('#')[0] + `#reserva-${r.id}`;
      const details = `${r.title}\nSala: ${r.room}\nData: ${fmtDate(r.date)} ${r.start}–${r.end}\nResp: ${r.owner}\nObs: ${r.notes||"-"}`;
      const editBtn = state.admin ? `<button class="btn btn-sm btn-link text-decoration-none" onclick="onEdit('${r.id}')">Editar</button>` : '';
      const delBtn  = state.admin ? `<button class="btn btn-sm btn-link text-decoration-none danger" onclick="onDelete('${r.id}')">Excluir</button>` : '';
      return `<tr id="reserva-${r.id}">
        <td>${fmtDate(r.date)}</td>
        <td>${r.start}</td>
        <td>${r.end}</td>
        <td>${roomBadge}</td>
        <td><a href="#reserva-${r.id}" class="link" onclick="alert(\`${details}\n\nLink: ${shareUrl}\`)">${r.title}</a></td>
        <td>${r.owner}</td>
        <td class="text-end">${editBtn} ${delBtn} <a class="link small" href="data:text/calendar;charset=utf-8,${encodeURIComponent(toICS(r))}" download="reserva_${r.id}.ics">.ics</a></td>
      </tr>`
    }

    // ===== ICS =====
    function dtLocalToICS(date, time){ const [Y,M,D]=date.split('-'); const [h,m]=time.split(':'); return `${Y}${M}${D}T${pad(h)}${pad(m)}00`; }
    function toICS(r){
      const esc = (s)=> (s||'').replace(/[\\;,\\n]/g,m=>({"\\":"\\\\",";":"\\;",",":[","],"\\n":"\\n"}[m]));
      return ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//RNascimento//Reservas//PT-BR','CALSCALE:GREGORIAN','BEGIN:VEVENT',
        `UID:${r.id}@reservas.local`,`DTSTAMP:${dtLocalToICS(r.date, r.start)}`,`DTSTART:${dtLocalToICS(r.date, r.start)}`,`DTEND:${dtLocalToICS(r.date, r.end)}`,
        `SUMMARY:${esc(r.title)}`,`DESCRIPTION:${esc(`Resp.: ${r.owner}\\nSala: ${r.room}\\nObs.: ${r.notes||''}`)}`,`LOCATION:${esc(r.room)}`,'END:VEVENT','END:VCALENDAR'].join('\\r\\n');
    }

    // ===== UI Events =====
    async function refresh(){
      try{
        const j = await apiList(); state.reservations = j.list; render(); focusAnchor();
      }catch(e){ showError(e?.message||'Acesso negado. Talvez fora do domínio.'); }
    }
    function showError(msg){ const el=$('#msg'); el.textContent=msg; el.className='small mt-2 text-danger'; }
    function clearMsg(){ const el=$('#msg'); el.textContent=''; el.className='small mt-2'; }

    $('#formReserva').addEventListener('submit', async (e)=>{
      e.preventDefault(); clearMsg();
      const room=$('#room').value.trim(); const date=$('#date').value; const start=$('#start').value; const end=$('#end').value;
      const title=$('#title').value.trim(); const owner=$('#owner').value.trim(); const notes=$('#notes').value.trim();
      const editingId = state.editingId;
      if(toMinutes(end)<=toMinutes(start)){ showError('Horário inválido: fim deve ser após o início.'); return; }
      let res;
      if(editingId){ res = await apiUpdate({id:editingId, room,date,start,end,title,owner,notes}); }
      else {
        const recWeekly=$('#recWeekly').checked; const recCount=parseInt($('#recCount').value,10)||1;
        res = await apiAdd({room,date,start,end,title,owner,notes,recWeekly,recCount});
      }
      if(!res.ok){
        if(res.error==='conflict'){ showError(`Conflito: já existe reserva neste intervalo em ${res.at}.`); }
        else if(res.error==='forbidden_domain'){ showError('Acesso restrito ao domínio mpmt.mp.br.'); }
        else { showError('Erro ao salvar.'); }
        return;
      }
      (e.target).reset(); state.editingId=''; $('#editId').value=''; $('#btnSave').textContent='Salvar reserva'; $('#btnCancelEdit').style.display='none'; document.querySelector('#recurrenceBlock').style.display='flex';
      refresh();
    });

    $('#btnCancelEdit').addEventListener('click', ()=>{
      state.editingId=''; $('#editId').value=''; $('#formReserva').reset(); $('#btnSave').textContent='Salvar reserva'; $('#btnCancelEdit').style.display='none'; document.querySelector('#recurrenceBlock').style.display='none' ? '' : 'flex'; clearMsg();
      document.querySelector('#recurrenceBlock').style.display='flex';
    });

    ['#fRoom','#fFrom','#fTo','#fQuery'].forEach(sel=> $(sel).addEventListener('input', refresh));
    $('#btnClearFilters').addEventListener('click',()=>{ $('#fRoom').value=''; $('#fFrom').value=''; $('#fTo').value=''; $('#fQuery').value=''; refresh(); });

    $('#btnExportCSV').addEventListener('click', ()=>{
      const header = ['id','sala','data','inicio','fim','titulo','responsavel','observacoes'];
      const rows = state.reservations.map(r=>[r.id,r.room,r.date,r.start,r.end,escapeCSV(r.title),escapeCSV(r.owner),escapeCSV(r.notes||'')]);
      const csv = [header.join(';'), ...rows.map(a=>a.join(';'))].join('\n');
      const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='reservas_filtro.csv'; a.click();
    });

    $('#btnAdmin').addEventListener('click', ()=>{ if(state.admin){ state.admin=false; render(); return; } const pin=prompt('PIN de admin:'); if(!pin) return; state.adminPin=pin; state.admin=true; render(); });

    window.onDelete = async function(id){ if(!state.admin) return; if(!confirm('Confirma excluir esta reserva?')) return; const res = await apiDelete(id); if(!res.ok){ alert(res.error==='forbidden_domain'?'Acesso restrito ao domínio.':'Falha ao excluir (verifique o PIN).'); return; } refresh(); }
    window.onEdit = function(id){
      const r = state.reservations.find(x=>x.id===id); if(!r) return;
      $('#editId').value=id; state.editingId=id; $('#room').value=r.room; $('#date').value=r.date; $('#start').value=r.start; $('#end').value=r.end; $('#title').value=r.title; $('#owner').value=r.owner; $('#notes').value=r.notes||'';
      $('#btnSave').textContent='Salvar edição'; $('#btnCancelEdit').style.display='inline-block'; document.querySelector('#recurrenceBlock').style.display='none'; window.scrollTo({top:0, behavior:'smooth'});
    }

    function focusAnchor(){ if(location.hash.startsWith('#reserva-')){ const el = document.querySelector(location.hash); if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}) } } }

    async function loadRooms(){
      try{
        const rooms = await apiRooms(); state.rooms = rooms;
        const roomSel = $('#room'); const fRoomSel = $('#fRoom');
        roomSel.innerHTML = '<option value="">Selecionar...</option>' + rooms.map(r=>`<option>${r}</option>`).join('');
        fRoomSel.innerHTML = '<option value="">Todas</option>' + rooms.map(r=>`<option>${r}</option>`).join('');
      }catch(e){ showError('Falha ao carregar salas. Verifique a aba "Config".'); }
    }

    (async function init(){ await loadRooms(); await refresh(); })();
    
    // Botão ICS (gerar rápido sem salvar)
    document.getElementById('btnICS').addEventListener('click', ()=>{
      const room=$('#room').value.trim(); const date=$('#date').value; const start=$('#start').value; const end=$('#end').value; const title=$('#title').value.trim()||'Reserva'; const owner=$('#owner').value.trim(); const notes=$('#notes').value.trim();
      if(!(room&&date&&start&&end)){ alert('Preencha sala, data, início e fim para gerar .ics.'); return; }
      const r={id:Math.random().toString(36).slice(2), room,date,start,end,title,owner,notes};
      const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//RNascimento//Reservas//PT-BR','CALSCALE:GREGORIAN','BEGIN:VEVENT',`UID:${r.id}@reservas.local`,`DTSTAMP:${dtLocalToICS(r.date, r.start)}`,`DTSTART:${dtLocalToICS(r.date, r.start)}`,`DTEND:${dtLocalToICS(r.date, r.end)}`,`SUMMARY:${title}`,`DESCRIPTION:Resp.: ${owner}\\nSala: ${room}\\nObs.: ${notes||''}`,`LOCATION:${room}`,'END:VEVENT','END:VCALENDAR'].join('\\r\\n');
      const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(ics); a.download='reserva.ics'; a.click();
    });
  </script>
</body>
</html>
